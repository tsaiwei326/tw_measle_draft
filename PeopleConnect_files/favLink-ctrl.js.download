var favLinksWidgetCtrl = angular.module('favLinksWidgetCtrl', ['ui.bootstrap']);
favLinksWidgetCtrl.controller('favLinksCtrl', ['$scope', '$uibModal', '$document', 'FavLinksService', 'Alertify',
    function ($scope, $uibModal, $document, FavLinksService, Alertify) {

        var self = $scope;
        self.animationsEnabled = true;
        self.eventsFeed = [];
        self.isFavLinksEmpty = false;
        self.user = {
            id: '',
            sitetags: ''
        };

        self.$watch(function () {
            return self.user;
        }, function (newVal) {
            _loadRss();
        });

        self.editFavLinks = function () {
            if (self.user.id !== '0') {
                self.updateFeeds();
            } else {
                self.showLoginError();
            }
        };

        self.updateFeeds = function () {
            var modalInstance = $uibModal.open({
                animation: self.animationsEnabled,
                ariaLabelledBy: 'modal-title',
                ariaDescribedBy: 'modal-body',
                templateUrl: 'addFavLinks.html',
                controller: 'addFavLinksCtrl',
                controllerAs: '$ctrl',
                size: 'large',
                resolve: {
                    user: function () {
                        return self.user;
                    }
                }
            });

            modalInstance.closed.then(function () {
                _loadRss();
            }, function () {
                // chain anything you want here
            });
        };

        self.showLoginError = function () {
            $uibModal.open({
                animation: self.animationsEnabled,
                ariaLabelledBy: 'modal-title',
                ariaDescribedBy: 'modal-body',
                templateUrl: 'loginError.html',
                controller: 'loginErrCtrl',
                controllerAs: '$ctrl',
                size: 'large',
            });
        };

        _loadRss = function() {

            var data = {
                userTableAutogeneratedId: self.user.id,
                sitetags: self.user.sitetags
            };

            FavLinksService.getfavLinks(data).then(function (response) {
                if (!response.data.length) {
                    self.isFavLinksEmpty = true;
                } else {
                    self.isFavLinksEmpty = false;
                }
                self.favLinks = response.data;
            }).catch(function (response) {
                console.log(response);
            });
        }
    }
]);
